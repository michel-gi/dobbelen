#!/usr/bin/env python3
# Importeer de class uit de nieuwe module
import argparse
import sys
import os
from database import TextDatabase

def toon_menu():
    """Toont het hoofdmenu met beschikbare opties."""
    print("\nVoer een itemnummer in om de bijbehorende tekst te zien.")
    print("Of kies een van de volgende menu opties:\n")
    print("[n]ieuw   - invoeren van een nieuw tekst item")
    print("[w]ijzig  - wijzigen van een bestaand tekst item")
    print("[v]erwijder - verwijderen van een tekst item")
    print("[s]top   - beëindig dit programma")
    print("[m]enu   - dit menu opnieuw weergeven")

def main():
    """Hoofdfunctie voor de gebruikersinteractie."""
    parser = argparse.ArgumentParser(
        prog="tekstdb_bewerk",  # Toon de juiste naam in helpberichten
        description="Een interactieve command-line tool om tekst-databases te bewerken.",
        # Zorgt voor correcte weergave van newlines in de helptekst
        formatter_class=argparse.RawTextHelpFormatter
    )
    # Een 'mutually exclusive group' zorgt dat -f en -cf niet tegelijk gebruikt kunnen worden
    group = parser.add_mutually_exclusive_group()
    group.add_argument(
        "-f", "--file",
        dest="filename",
        help="Gebruik een bestaand databasebestand."
    )
    group.add_argument(
        "-cf", "--create-file",
        dest="create_filename",
        help="Creëer een nieuw, leeg databasebestand.\nLET OP: Kan een bestaand bestand met dezelfde naam\noverschrijven na uw bevestiging."
    )

    args = parser.parse_args()

    # Standaard gedrag als er geen argumenten worden meegegeven
    bestandsnaam = "mijn_tekstdatabase.txt"
    create_new = False

    if args.filename:
        if not os.path.exists(args.filename):
            print(f"Fout: Bestand '{args.filename}' niet gevonden.", file=sys.stderr)
            sys.exit(1)
        bestandsnaam = args.filename
    elif args.create_filename:
        if os.path.exists(args.create_filename):
            print(f"Waarschuwing: Bestand '{args.create_filename}' bestaat al.")
            while True:
                bevestiging = input("Weet u zeker dat u dit wilt overschrijven met een lege database? (j/n): ").lower()
                if bevestiging.startswith('j'):
                    break
                elif bevestiging.startswith('n'):
                    print("Operatie geannuleerd.")
                    sys.exit(0)
        bestandsnaam = args.create_filename
        create_new = True

    # Maak één database object aan. Alle operaties gaan via dit object.
    db = TextDatabase(bestandsnaam, create_new=create_new)
    toon_menu()  # Toon het menu direct bij de start
    
    while True:
        try:
            aantal_items = len(db.data)
            if aantal_items > 0:
                prompt_tekst = f"\nKies een optie of een nummer (1-{aantal_items}): "
            else:
                # Een meer behulpzame prompt als de database leeg is.
                prompt_tekst = "\nDatabase is leeg. Kies '[n]ieuw' om een item toe te voegen: "

            gebruikers_invoer = input(prompt_tekst)
            invoer_lower = gebruikers_invoer.lower()

            try:
                index_nummer = int(gebruikers_invoer)
                tekst = db.get_tekst(index_nummer)

                if tekst is not None:
                    print(f"\n--- Tekst voor index {index_nummer} ---")
                    print(tekst)
                    print(f"--- Einde tekst voor index {index_nummer} ---")
                else:
                    print(f"Geen tekst gevonden voor index {index_nummer}.")

            except ValueError:  # Not a valid number, check for commands
                match invoer_lower:
                    case 'stop' | 's':
                        break

                    case 'menu' | 'm':
                        toon_menu()

                    case 'nieuw' | 'n':
                        print("Voer de nieuwe tekst in. Laat een lege regel achter om op te slaan.")
                        nieuwe_tekst_regels = []
                        while True:
                            regel = input()
                            if not regel.strip():
                                break
                            nieuwe_tekst_regels.append(regel)

                        nieuwe_tekst = "\n".join(nieuwe_tekst_regels)
                        if db.voeg_tekst_toe(nieuwe_tekst):
                            print("Tekst succesvol toegevoegd.")
                            print(f"Totaal aantal items in de database nu: {len(db.data)}")
                        else:
                            print("Fout: Kon de nieuwe tekst niet opslaan.")

                    case 'wijzig' | 'w':
                        try:
                            index_nummer = int(input("Voer het indexnummer in van de tekst die u wilt wijzigen: "))
                            if index_nummer not in db.data:
                                print(f"Fout: Geen tekst gevonden voor index {index_nummer}.")
                            else:
                                huidige_tekst = db.get_tekst(index_nummer)
                                print(f"\n--- Huidige tekst voor index {index_nummer} ---")
                                print(huidige_tekst)
                                print("--- Einde huidige tekst ---\n")
                                print("\nVoer nu de nieuwe tekst in. Laat een lege regel achter om op te slaan.")
                                nieuwe_tekst_regels = []
                                while True:
                                    regel = input()
                                    if not regel.strip():
                                        break
                                    nieuwe_tekst_regels.append(regel)
                                nieuwe_tekst = "\n".join(nieuwe_tekst_regels)
                                if db.wijzig_tekst(index_nummer, nieuwe_tekst):
                                    print(f"Tekst voor index {index_nummer} succesvol gewijzigd.")
                                else:
                                    print(f"Fout: Kon tekst voor index {index_nummer} niet wijzigen.")
                        except ValueError:
                            print("Ongeldige invoer voor indexnummer. Voer een getal in.")

                    case 'verwijder' | 'v':
                        try:
                            index_nummer = int(input("Voer het indexnummer in van de tekst die u wilt verwijderen: "))
                            if index_nummer not in db.data:
                                print(f"Fout: Geen tekst gevonden voor index {index_nummer}.")
                            else:
                                print(f"\n--- Tekst voor index {index_nummer} die verwijderd wordt ---\n{db.get_tekst(index_nummer)}\n--- Einde tekst ---\n")
                                while True:
                                    bevestiging = input(f"Weet u zeker dat u item {index_nummer} wilt verwijderen? (j/n): ")
                                    if bevestiging.lower().startswith('j'):
                                        if db.verwijder_tekst(index_nummer):
                                            print(f"Item {index_nummer} succesvol verwijderd.")
                                            print(f"Totaal aantal items in de database nu: {len(db.data)}")
                                        else:
                                            print(f"Fout: Kon item {index_nummer} niet verwijderen.")
                                        break
                                    elif bevestiging.lower().startswith('n'):
                                        print(f"Verwijdering van item {index_nummer} geannuleerd.")
                                        break
                                    else:
                                        print("Ongeldige invoer. Voer 'j' of 'n' in.")
                        except ValueError:
                            print("Ongeldige invoer voor indexnummer. Voer een getal in.")
                    case _:  # Handle other invalid input (including non-integer which falls through from Try)
                        print(f"Ongeldige invoer. '{gebruikers_invoer}' is geen geldig nummer of commando.")


        except ValueError:
            print(f"Ongeldige invoer. '{gebruikers_invoer}' is geen geldig nummer of commando.")


if __name__ == "__main__":
    main()
